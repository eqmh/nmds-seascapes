---
title: "Seascape NMDS"
output:
  html_document:
    df_print: paged
---

This Rmd reads data table containing taxa densities collected during IMARPE fisheries surveys (Peru) and seascape class identified at each sampled site from monthly and 8-day seascapes at 4km pixel. NMDS plots are created with these data to evaluate seascape affinity by taxonomic groups. These tables are generated by the Matlab routine 'imarpe_survey.m'. 

NMDS is generated using code at https://jkzorz.github.io/2019/06/06/NMDS.html

```{r, message=FALSE}
library(vegan)
library(dplyr)
library(ggplot2)
library(reshape2)
library(RColorBrewer)
```


```{r}

# reads the tables and transforms the last two columns to characters 
df_month <- read.csv("taxa_table_month.csv", header= TRUE) # this is the full table with many unnecessary columns
df_month[52:53] <- lapply(df_month[52:53], as.character)
df_8d <- read.csv("taxa_table_8d.csv", header= TRUE) # this is the full table with many unnecessary columns
df_8d[52:53] <- lapply(df_8d[52:53], as.character)

# use this for cleaned tables (without unnecessary columns)
df_8d <- read.csv("taxa_table_8d_v2.csv", header= TRUE)
df_8d[8:9] <- lapply(df_8d[8:9], as.character)

# first data visualization
df_mo_long <- df_month
df_mo_long <- melt(df_mo_long, id.vars=c("sample", "seascape"))
df_8d_long <- df_8d
df_8d_long <- melt(df_8d_long, id.vars=c("sample", "seascape")) 

# monthly matchings
nb.cols <- 51 
mycolors <- colorRampPalette(brewer.pal(8, "Spectral"))(nb.cols)
p_month <- ggplot(df_mo_long, aes(fill=variable, y=value, x=seascape)) + 
    geom_bar(position="stack", stat="identity") +
    scale_fill_manual(values = mycolors) +
    labs(title = "Monthly seascapes (August 2017)")
p_month
ggsave("p_month.jpg")

# 8-day matchings
df_8d_long$seascape <- factor(df_8d_long$seascape,                                    # Change ordering manually
                  levels = c("7", "14", "15", "21"))
nb.cols <- 7 # use 51 for taxa_table_8d and 7 for taxa_table_8d_v2
mycolors <- colorRampPalette(brewer.pal(8, "Spectral"))(nb.cols)
p_8d <- ggplot(df_8d_long, aes(fill=variable, y=value, x=seascape)) + 
    geom_bar(position="stack", stat="identity") +
    scale_fill_manual(values = mycolors) +
    labs(title = "8-day seascapes (Aug 23 - Sep 9, 2017)")
p_8d
ggsave("p_8d.jpg")

## count rows with elements > 0 (select all zero elements only - abscence values)
no_taxa_month <- df_month[apply(df_month[, 1:51]==0, 1, all),]
no_taxa_8d <- df_8d[apply(df_8d[, 1:51]==0, 1, all),]
u_seas_mo <- unique(no_taxa_month[, 53])
u_seas_8d <- unique(no_taxa_8d[, 53])

zero_mo <- NULL
for (x in 1:length(u_seas_mo)) {
  seas_idx <- u_seas_mo[x]
  tmp <- length(which(no_taxa_month$seascape == as.character(seas_idx)))
  tmp2 <- c(seas_idx, tmp)
  zero_mo <- cbind(zero_mo, tmp2)
}

zero_8d <- NULL
for (x in 1:length(u_seas_8d)) {
  seas_idx <- u_seas_8d[x]
  tmp <- length(which(no_taxa_8d$seascape == as.character(seas_idx)))
  tmp2 <- c(seas_idx, tmp)
  zero_8d <- cbind(zero_8d, tmp2)
}
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.
```{r}
# remove rows with all zeros 
df_month <- df_month[!apply(df_month[, 1:51]==0, 1, all),]
df_8d <- df_8d[!apply(df_8d[, 1:51]==0, 1, all),]

## run the metaMDS command from the vegan package to generate an NMDS plot.
set.seed(123)
nmds_month = metaMDS(df_month[, 1:51], distance = "bray")
nmds_month

nmds_8d = metaMDS(df_8d[, 1:51], distance = "bray")
nmds_8d

plot(nmds_month)
plot(nmds_8d)

#extract NMDS scores (x and y coordinates)
data.scores_month = as.data.frame(scores(nmds_month))
data.scores_8d = as.data.frame(scores(nmds_8d))

#add columns to data frame 
data.scores_month$seascape = df_month$seascape
head(data.scores_month)
data.scores_8d$seascape = df_8d$seascape
head(data.scores_8d)

```

```{r}
xx_month = ggplot(data.scores_month, aes(x = NMDS1, y = NMDS2)) + 
    geom_point(size = 4, aes( colour = seascape))+ 
    theme(axis.text.y = element_text(colour = "black", size = 12, face = "bold"), 
    axis.text.x = element_text(colour = "black", face = "bold", size = 12), 
    legend.text = element_text(size = 12, face ="bold", colour ="black"), 
    legend.position = "right", axis.title.y = element_text(face = "bold", size = 14), 
    axis.title.x = element_text(face = "bold", size = 14, colour = "black"), 
    legend.title = element_text(size = 14, colour = "black", face = "bold"), 
    panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2)) 
xx_month
    
#ggsave("NMDS.svg")

xx_8d = ggplot(data.scores_8d, aes(x = NMDS1, y = NMDS2)) + 
    geom_point(size = 4, aes( colour = seascape))+ 
    theme(axis.text.y = element_text(colour = "black", size = 12, face = "bold"), 
    axis.text.x = element_text(colour = "black", face = "bold", size = 12), 
    legend.text = element_text(size = 12, face ="bold", colour ="black"), 
    legend.position = "right", axis.title.y = element_text(face = "bold", size = 14), 
    axis.title.x = element_text(face = "bold", size = 14, colour = "black"), 
    legend.title = element_text(size = 14, colour = "black", face = "bold"), 
    panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2)) 
xx_8d

#ggsave("NMDS.svg")
```

